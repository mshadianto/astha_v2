# ===== app/main.py (FINAL FIXED VERSION - NO IMPORT ERRORS) =====
import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import requests
import json
from datetime import datetime, timedelta
import math
import sys
import os
from pathlib import Path

# Page configuration
st.set_page_config(
    page_title="ASTHA - Hajj Treasury Analytics",
    page_icon="üïå",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for better styling
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        padding: 2rem;
        border-radius: 1rem;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 5px solid #10b981;
        margin-bottom: 1rem;
    }
    .stSelectbox label, .stNumberInput label, .stSlider label {
        font-weight: 600;
        color: #374151;
    }
    .agent-status {
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    .liability-result {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        text-align: center;
        margin: 1rem 0;
    }
    .stress-test-safe {
        background: #dcfce7;
        border-left: 4px solid #16a34a;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    .stress-test-risk {
        background: #fef2f2;
        border-left: 4px solid #dc2626;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    .info-box {
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
    }
    .version-badge {
        background: #10b981;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8em;
        font-weight: 600;
        display: inline-block;
        margin: 0.5rem;
    }
</style>
""", unsafe_allow_html=True)

# ====== CONFIGURATION CLASS ======
class AppConfig:
    """Application configuration"""
    APP_NAME = "ASTHA - Hajj Treasury Analytics"
    APP_VERSION = "1.2.1"  # Fixed HTML rendering issue
    BUILD_DATE = datetime.now().strftime("%Y.%m.%d")
    DEVELOPER = "MS Hadianto"
    ORGANIZATION = "Badan Pengelola Keuangan Haji (BPKH)"
    DEBUG = True
    
    # Default calculation parameters
    DEFAULT_TOTAL_JEMAAH = 2500000
    DEFAULT_INFLASI_SAUDI = 3.5
    DEFAULT_KURS_USD = 15500
    DEFAULT_TINGKAT_DISKONTO = 6.5
    DEFAULT_TAHUN_PROYEKSI = 20
    
    @staticmethod
    def get_version_info():
        """Get dynamic version information"""
        return {
            'version': AppConfig.APP_VERSION,
            'build_date': AppConfig.BUILD_DATE,
            'developer': AppConfig.DEVELOPER,
            'full_version': f"v{AppConfig.APP_VERSION}.{AppConfig.BUILD_DATE}"
        }
    
    @staticmethod
    def get_changelog():
        """Get application changelog"""
        return {
            'v1.2.1': [
                "üîß Fixed HTML rendering issue in footer disclaimer",
                "‚úÖ Improved disclaimer layout with native Streamlit components",
                "‚úÖ Enhanced readability and cross-platform compatibility",
                "‚úÖ Simplified CSS styling for better performance"
            ],
            'v1.2.0': [
                "‚úÖ Added footer disclaimer with comprehensive legal notices",
                "‚úÖ Added developer attribution (MS Hadianto)",
                "‚úÖ Implemented dynamic versioning system",
                "‚úÖ Enhanced sidebar with app info and quick help",
                "‚úÖ Added about dialog and changelog",
                "‚úÖ Improved security and privacy information"
            ],
            'v1.1.0': [
                "‚úÖ Fixed all import errors for standalone operation",
                "‚úÖ Implemented complete Monte Carlo simulation",
                "‚úÖ Enhanced AI Assistant with better responses",
                "‚úÖ Added comprehensive stress testing scenarios",
                "‚úÖ Improved chart visualizations and UX"
            ],
            'v1.0.0': [
                "üéâ Initial release with core features",
                "üìä Dashboard with real-time KPI monitoring",
                "üßÆ Actuarial liability calculation engine",
                "üìà Stress testing and scenario analysis", 
                "ü§ñ AI Assistant with knowledge base"
            ]
        }

# ====== UTILITY FUNCTIONS ======
def format_rupiah(value):
    """Format number as Rupiah currency"""
    if value >= 1e12:
        return f"Rp {value/1e12:.1f}T"
    elif value >= 1e9:
        return f"Rp {value/1e9:.1f}M"
    elif value >= 1e6:
        return f"Rp {value/1e6:.1f}jt"
    else:
        return f"Rp {value:,.0f}"

def format_percentage(value, decimals=1):
    """Format number as percentage"""
    return f"{value:.{decimals}f}%"

def format_number(value, decimals=0):
    """Format number with thousands separator"""
    return f"{value:,.{decimals}f}"

# ====== DATA LOADING FUNCTIONS ======
@st.cache_data
def load_historical_data():
    """Load historical hajj cost data"""
    # Try to load from CSV first, fallback to hardcoded data
    try:
        if os.path.exists("data/biaya_haji_historis.csv"):
            df = pd.read_csv("data/biaya_haji_historis.csv")
            return df
    except Exception as e:
        st.warning(f"‚ö†Ô∏è Could not load CSV file: {e}")
    
    # Fallback to hardcoded data
    data = {
        'Tahun': [2022, 2023, 2024, 2025],
        'BPIH': [85452883, 89629474, 94482028, 91493896],
        'Bipih': [39886009, 49812700, 56046172, 60559399],
        'NilaiManfaat': [45566874, 39816774, 38435856, 30934497]
    }
    return pd.DataFrame(data)

@st.cache_data
def get_exchange_rates():
    """Get current exchange rates"""
    try:
        # Simulate API call - replace with real API if needed
        # For demo purposes, using static data with small random variations
        base_usd = 15500
        base_sar = 4133
        
        # Add small random variation to simulate live data
        import random
        usd_rate = base_usd + random.randint(-50, 50)
        sar_rate = base_sar + random.randint(-20, 20)
        
        return {
            'USD': usd_rate,
            'SAR': sar_rate,
            'timestamp': datetime.now(),
            'source': 'Simulated Live Data'
        }
    except Exception as e:
        st.error(f"Error fetching exchange rates: {e}")
        return {
            'USD': 15500,
            'SAR': 4133,
            'timestamp': datetime.now(),
            'source': 'Default Values'
        }

@st.cache_data
def get_economic_indicators():
    """Get economic indicators"""
    return {
        'saudi_inflation': 3.2,
        'indonesia_inflation': 2.8,
        'bi_rate': 6.0,
        'us_treasury_10y': 4.5,
        'fed_rate': 5.25,
        'source': 'Economic Data Simulation'
    }

# ====== LIABILITY CALCULATOR CLASS ======
class LiabilityCalculator:
    """Actuarial liability calculation engine"""
    
    @staticmethod
    def calculate_total_liability(
        total_jemaah: int,
        inflasi_saudi: float,
        kurs_usd: float,
        biaya_awal: float,
        tingkat_diskonto: float,
        tahun_proyeksi: int = 20,
        depresiasi_rupiah: float = 3.0
    ):
        """
        Calculate total present value of hajj liability
        Formula: L_total = Œ£ (C_t √ó J_t) / (1+r)^t
        """
        total_liability = 0
        jemaah_per_tahun = total_jemaah / tahun_proyeksi
        projections = []
        
        for t in range(1, tahun_proyeksi + 1):
            # C_t = C_0 √ó (1 + inflasi_saudi)^t √ó (1 + depresiasi_rupiah)^t
            biaya_tahun_t = biaya_awal * \
                           (1 + inflasi_saudi/100)**t * \
                           (1 + depresiasi_rupiah/100)**t
            
            # Present Value = Future Value / (1 + discount_rate)^t
            present_value = (biaya_tahun_t * jemaah_per_tahun) / \
                           (1 + tingkat_diskonto/100)**t
            
            total_liability += present_value
            
            projections.append({
                'tahun': 2025 + t,
                'biaya_per_jemaah': biaya_tahun_t,
                'jemaah': jemaah_per_tahun,
                'total_biaya': biaya_tahun_t * jemaah_per_tahun,
                'present_value': present_value
            })
        
        return total_liability, projections
    
    @staticmethod
    def sensitivity_analysis(base_params, sensitivity_params):
        """Perform sensitivity analysis on key parameters"""
        results = []
        base_liability, _ = LiabilityCalculator.calculate_total_liability(**base_params)
        
        for param_name, param_values in sensitivity_params.items():
            for value in param_values:
                params = base_params.copy()
                params[param_name] = value
                
                liability, _ = LiabilityCalculator.calculate_total_liability(**params)
                change_pct = ((liability - base_liability) / base_liability) * 100
                
                results.append({
                    'parameter': param_name,
                    'value': value,
                    'liability': liability,
                    'change_percent': change_pct
                })
        
        return results

# ====== STRESS TEST ENGINE ======
class StressTestEngine:
    """Stress testing and scenario analysis"""
    
    @staticmethod
    def run_stress_scenarios(base_assets: float, base_liability: float):
        """Run predefined stress test scenarios"""
        scenarios = {
            "üìä Skenario Dasar": {
                "liability_mult": 1.0,
                "asset_mult": 1.0,
                "description": "Kondisi normal tanpa shock eksternal"
            },
            "üìâ Resesi Global": {
                "liability_mult": 1.15,
                "asset_mult": 0.85,
                "description": "Imbal hasil investasi turun, biaya naik"
            },
            "üí± Depresiasi Rupiah Ekstrem": {
                "liability_mult": 1.45,
                "asset_mult": 0.95,
                "description": "Rupiah melemah 30% dalam 2 tahun"
            },
            "üìà Inflasi Saudi Tinggi": {
                "liability_mult": 1.25,
                "asset_mult": 1.02,
                "description": "Inflasi Saudi mencapai 8% per tahun"
            },
            "‚ö° Shock Ganda": {
                "liability_mult": 1.60,
                "asset_mult": 0.80,
                "description": "Kombinasi resesi + depresiasi + inflasi"
            }
        }
        
        results = []
        for scenario_name, params in scenarios.items():
            scenario_liability = base_liability * params["liability_mult"]
            scenario_assets = base_assets * params["asset_mult"]
            solvency_ratio = scenario_assets / scenario_liability
            
            status = "Aman" if solvency_ratio >= 1.2 else \
                    "Waspada" if solvency_ratio >= 1.0 else "Risiko Tinggi"
            
            results.append({
                'scenario': scenario_name,
                'description': params['description'],
                'assets': scenario_assets,
                'liability': scenario_liability,
                'solvency_ratio': solvency_ratio,
                'status': status
            })
        
        return results
    
    @staticmethod
    def monte_carlo_simulation(base_assets: float, base_liability: float, n_simulations: int = 1000):
        """Run Monte Carlo simulation for risk assessment"""
        np.random.seed(42)
        
        # Random factors with normal distribution
        liability_factors = np.random.normal(1.0, 0.15, n_simulations)
        asset_factors = np.random.normal(1.0, 0.10, n_simulations)
        
        # Ensure factors are positive
        liability_factors = np.abs(liability_factors)
        asset_factors = np.abs(asset_factors)
        
        simulated_solvency = (base_assets * asset_factors) / (base_liability * liability_factors)
        
        results = {
            'solvency_ratios': simulated_solvency,
            'mean_solvency': np.mean(simulated_solvency),
            'std_solvency': np.std(simulated_solvency),
            'safe_probability': (simulated_solvency >= 1.0).mean() * 100,
            'worst_case': np.min(simulated_solvency),
            'best_case': np.max(simulated_solvency)
        }
        
        return results

# ====== AI AGENTS SIMULATION ======
class AgentOrchestrator:
    def __init__(self):
        self.agents = {
            'data_collector': {'status': 'active', 'last_update': datetime.now()},
            'liability_analyst': {'status': 'active', 'last_update': datetime.now()},
            'investment_simulator': {'status': 'active', 'last_update': datetime.now()},
            'reporting_agent': {'status': 'standby', 'last_update': datetime.now()}
        }
    
    def get_agent_status(self):
        return self.agents
    
    def calculate_liability(self, total_jemaah, inflasi_saudi, kurs_usd, biaya_awal, tingkat_diskonto, tahun_proyeksi=20):
        """Calculate total liability using actuarial formula"""
        return LiabilityCalculator.calculate_total_liability(
            total_jemaah, inflasi_saudi, kurs_usd, biaya_awal, tingkat_diskonto, tahun_proyeksi
        )

# ====== INITIALIZE AGENTS ======
@st.cache_resource
def init_agents():
    return AgentOrchestrator()

# ====== AI RESPONSE GENERATOR ======
def generate_ai_response(prompt):
    """Generate AI response based on prompt"""
    prompt_lower = prompt.lower()
    
    responses = {
        'liabilitas': """
        üìä **Total Liabilitas Saat Ini**: Berdasarkan kalkulasi terkini menggunakan formula aktuaria, total liabilitas BPKH adalah sekitar **Rp 145.2 Triliun**.
        
        **Formula yang Digunakan:**
        - **L_total = Œ£ (C_t √ó J_t) / (1+r)^t**
        - Mempertimbangkan 2.5 juta jemaah tunggu
        - Proyeksi inflasi Saudi 3.5% per tahun
        - Tingkat diskonto 6.5%
        - Periode proyeksi 20 tahun
        
        üí° Gunakan halaman "Kalkulasi Liabilitas" untuk simulasi dengan parameter berbeda.
        """,
        
        'solvabilitas': """
        üõ°Ô∏è **Rasio Solvabilitas** adalah perbandingan antara total aset dengan total liabilitas.
        
        **Formula**: Rasio = Total Aset √∑ Total Liabilitas
        
        **Status Saat Ini**:
        - Total Aset: Rp 180.5 Triliun
        - Total Liabilitas: Rp 145.2 Triliun  
        - **Rasio Solvabilitas: 1.24** ‚úÖ
        
        **Interpretasi**:
        - Rasio > 1.2: Zona Aman üü¢
        - Rasio 1.0-1.2: Zona Waspada üü°
        - Rasio < 1.0: Zona Risiko üî¥
        """,
        
        'inflasi': """
        üìà **Dampak Inflasi Saudi terhadap Biaya Haji**:
        
        **Inflasi Saat Ini**: 3.2% per tahun
        
        **Dampak Langsung**:
        - üí∞ Biaya akomodasi naik sesuai inflasi
        - üçΩÔ∏è Living cost jemaah meningkat
        - üöå Tarif transportasi lokal naik
        
        **Simulasi Dampak**:
        - Inflasi naik 1% ‚Üí Liabilitas naik ~8.5%
        - Inflasi naik 2% ‚Üí Liabilitas naik ~17.2%
        
        ‚ö†Ô∏è **Mitigasi**: Diversifikasi mata uang dan hedging currency exposure.
        """,
        
        'stress test': """
        üß™ **Cara Melakukan Stress Testing**:
        
        **Langkah-langkah**:
        1. üìä Tentukan skenario shock (resesi, depresiasi, inflasi)
        2. üìà Hitung dampak terhadap aset dan liabilitas
        3. üîç Analisis rasio solvabilitas hasil
        4. ‚ö° Evaluasi tindakan mitigasi
        
        **Skenario Standar**:
        - **Resesi**: Asset -15%, Liability +15%
        - **Depresiasi**: Rupiah melemah 30%
        - **Inflasi**: Inflasi Saudi naik ke 8%
        
        üéØ Gunakan halaman "Simulasi & Stress Test" untuk analisis lengkap.
        """,
        
        'proyeksi': """
        üîÆ **Proyeksi Biaya Haji 5 Tahun ke Depan**:
        
        **Asumsi Dasar**:
        - Inflasi Saudi: 3.5% per tahun
        - Depresiasi Rupiah: 3% per tahun
        - Kenaikan biaya operasional: 2% per tahun
        
        **Proyeksi Biaya per Jemaah**:
        - 2026: Rp 97.8 juta (+6.9%)
        - 2027: Rp 104.5 juta (+6.9%)
        - 2028: Rp 111.7 juta (+6.9%)
        - 2029: Rp 119.4 juta (+6.9%)
        - 2030: Rp 127.6 juta (+6.9%)
        
        üìä **Total Kebutuhan Dana**: Proyeksi menunjukkan pertumbuhan eksponensial.
        """,
        
        'regulasi': """
        üìã **Regulasi Pengelolaan Dana Haji**:
        
        **Dasar Hukum Utama**:
        - üèõÔ∏è UU No. 8/2019 tentang Penyelenggaraan Ibadah Haji dan Umrah
        - üìÑ PP No. 5/2018 tentang BPKH
        - üìÑ Peraturan BPKH tentang Investasi
        
        **Prinsip Investasi**:
        - ‚úÖ Harus sesuai prinsip syariah
        - ‚úÖ Prudent (kehati-hatian)
        - ‚úÖ Transparan dan akuntabel
        - ‚úÖ Mengutamakan keamanan dana
        
        **Batasan Investasi**:
        - Maksimal 30% di instrumen ekuitas
        - Minimal 40% di instrumen fixed income
        """
    }
    
    # Check for keyword matches
    for keyword, response in responses.items():
        if keyword in prompt_lower:
            return response
    
    # Default response
    return """
    ü§î Maaf, saya belum sepenuhnya memahami pertanyaan Anda. 
    
    Silakan tanyakan tentang:
    - üìä **Liabilitas**: Total kewajiban keuangan haji
    - üõ°Ô∏è **Solvabilitas**: Rasio kesehatan keuangan  
    - üìà **Inflasi**: Dampak inflasi Saudi terhadap biaya haji
    - üìã **Regulasi**: Undang-undang dan peraturan terkait
    - üß™ **Stress Test**: Simulasi skenario risiko
    - üîÆ **Proyeksi**: Perkiraan biaya masa depan
    
    Atau gunakan kata kunci seperti "liabilitas", "solvabilitas", "inflasi", "stress test", "proyeksi", atau "regulasi" dalam pertanyaan Anda! üòä
    """

# ====== FOOTER DISCLAIMER FUNCTION ======
def render_footer_disclaimer():
    """Render footer with disclaimer and developer info"""
    version_info = AppConfig.get_version_info()
    
    # Simple markdown-based disclaimer
    st.markdown("---")
    st.markdown("## ‚ö†Ô∏è DISCLAIMER & INFORMASI APLIKASI")
    
    # Disclaimer section
    st.markdown("### üîç Disclaimer:")
    st.markdown("""
    - Aplikasi ini adalah alat bantu analisis dan simulasi untuk keperluan internal BPKH
    - Hasil kalkulasi dan proyeksi bersifat estimatif berdasarkan asumsi yang dapat berubah
    - Data yang ditampilkan sebagian bersifat simulasi untuk tujuan demonstrasi
    - Keputusan investasi dan kebijakan harus mempertimbangkan faktor-faktor lain yang relevan
    - BPKH tidak bertanggung jawab atas kerugian yang timbul dari penggunaan aplikasi ini
    """)
    
    # App information
    st.markdown("### üìä Tentang Aplikasi:")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown(f"""
        - **Nama:** {AppConfig.APP_NAME}
        - **Versi:** `{version_info['full_version']}`
        - **Developer:** **{AppConfig.DEVELOPER}**
        """)
    with col2:
        st.markdown(f"""
        - **Build Date:** {version_info['build_date']}
        - **Organisasi:** {AppConfig.ORGANIZATION}
        - **Tech Stack:** Python, Streamlit, Plotly
        """)
    
    # Security & Privacy
    st.markdown("### üîí Keamanan & Privasi:")
    st.markdown("""
    - Data sensitif tidak disimpan secara permanen dalam aplikasi
    - Semua kalkulasi dilakukan secara lokal dalam browser
    - Aplikasi tidak mengirim data ke server eksternal tanpa persetujuan
    - Gunakan aplikasi ini hanya di lingkungan yang aman dan terpercaya
    """)
    
    # Technical Support
    st.markdown("### üìû Dukungan Teknis:")
    st.markdown("""
    - **Email:** sopian@bpkh.go.id
    - **Dokumentasi:** User Manual ASTHA (akan tersedia)
    - **Repository:** Internal BPKH Repository (akan tersedia)
    """)
    
    # Copyright footer
    st.markdown("---")
    st.markdown(f"""
    <div style="text-align: center; color: #6b7280; padding: 1rem;">
        <p>¬© 2025 Badan Pengelola Keuangan Haji (BPKH)</p>
        <p><small>Developed with ‚ù§Ô∏è by <strong>{AppConfig.DEVELOPER}</strong> | Powered by Streamlit & Python</small></p>
        <p><small>Last Updated: {datetime.now().strftime('%d %B %Y, %H:%M WIB')} | Version: {version_info['full_version']}</small></p>
    </div>
    """, unsafe_allow_html=True)
    
    # Changelog expander
    with st.expander("üìù Version History & Changelog", expanded=False):
        changelog = AppConfig.get_changelog()
        
        for version, changes in changelog.items():
            if version == f"v{AppConfig.APP_VERSION}":
                st.markdown(f"### üîß {version} (Current - Hotfix)")
            else:
                st.markdown(f"### {version}")
            
            for change in changes:
                st.markdown(f"- {change}")
            st.markdown("---")

# ====== MAIN APPLICATION FUNCTION ======
def main():
    # Initialize
    agents = init_agents()
    historical_data = load_historical_data()
    exchange_rates = get_exchange_rates()
    economic_indicators = get_economic_indicators()
    
    # Get version info
    version_info = AppConfig.get_version_info()
    
    # Show version update notification
    if "1.2.1" in version_info['version']:
        st.success(f"""
        üîß **ASTHA {version_info['full_version']} - Hotfix Released!** 
        
        **üÜï Fixed in this version:**
        ‚Ä¢ Resolved HTML rendering issue in footer disclaimer
        ‚Ä¢ Improved cross-platform compatibility
        ‚Ä¢ Enhanced readability with native Streamlit components
        ‚Ä¢ Better performance with simplified styling
        
        Developed by **{AppConfig.DEVELOPER}** for BPKH.
        """)
    
    # Main header
    st.markdown(f"""
    <div class="main-header">
        <h1>üïå ASTHA <span class="version-badge">v{AppConfig.APP_VERSION}</span></h1>
        <h2>Agentic Sustainability for Hajj Treasury Analytics</h2>
        <p style="font-size: 1.1em; margin-top: 1rem;">
            Badan Pengelola Keuangan Haji (BPKH)
        </p>
        <p style="font-size: 0.9em; opacity: 0.9;">
            Powered by AI Agents & Advanced Analytics | {version_info['full_version']}
        </p>
        <p style="font-size: 0.8em; opacity: 0.8;">
            Developed by {AppConfig.DEVELOPER} | Build: {version_info['build_date']}
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Sidebar navigation
    st.sidebar.title("üß≠ Navigation")
    page = st.sidebar.selectbox(
        "Pilih Halaman",
        ["üè† Dashboard", "üßÆ Kalkulasi Liabilitas", "üìä Simulasi & Stress Test", "ü§ñ AI Assistant", "üìà Analytics", "üìã Reports"]
    )
    
    # Agent Status in Sidebar
    st.sidebar.markdown("---")
    st.sidebar.markdown("### ü§ñ Status AI Agents")
    agent_status = agents.get_agent_status()
    for agent_name, status in agent_status.items():
        status_color = "üü¢" if status['status'] == 'active' else "üü°"
        st.sidebar.markdown(f"{status_color} **{agent_name.replace('_', ' ').title()}**")
        st.sidebar.caption(f"Status: {status['status']} | Update: {status['last_update'].strftime('%H:%M')}")
    
    # Data source info in sidebar
    st.sidebar.markdown("---")
    st.sidebar.markdown("### üìä Data Sources")
    st.sidebar.caption(f"üí± Exchange: {exchange_rates['source']}")
    st.sidebar.caption(f"üìà Economic: {economic_indicators['source']}")
    st.sidebar.caption(f"üïê Last Update: {exchange_rates['timestamp'].strftime('%H:%M')}")
    
    # Version info in sidebar
    st.sidebar.markdown("---")
    st.sidebar.markdown("### ‚ÑπÔ∏è App Info")
    st.sidebar.caption(f"üì± Version: {version_info['full_version']}")
    st.sidebar.caption(f"üë®‚Äçüíª Developer: {AppConfig.DEVELOPER}")
    st.sidebar.caption(f"üèóÔ∏è Build: {version_info['build_date']}")
    st.sidebar.caption(f"üè¢ {AppConfig.ORGANIZATION}")
    
    # About button
    if st.sidebar.button("üìã About ASTHA", use_container_width=True):
        st.sidebar.markdown(f"""
        **üïå ASTHA** adalah aplikasi analisis sustainabilitas keuangan haji yang menggunakan teknologi AI dan metodologi aktuaria untuk membantu BPKH dalam:
        
        ‚Ä¢ üìä Monitoring KPI real-time
        ‚Ä¢ üßÆ Kalkulasi liabilitas aktuaria  
        ‚Ä¢ üìà Simulasi stress testing
        ‚Ä¢ ü§ñ Analisis berbasis AI
        
        **Teknologi:** Python, Streamlit, Plotly
        **Metodologi:** Actuarial Science, Monte Carlo
        
        ---
        *{AppConfig.APP_NAME}*  
        *{version_info['full_version']} by {AppConfig.DEVELOPER}*
        """)
    
    # Quick help
    if st.sidebar.button("‚ùì Quick Help", use_container_width=True):
        st.sidebar.markdown("""
        **üöÄ Quick Start:**
        1. Mulai dari Dashboard untuk overview
        2. Gunakan Kalkulasi Liabilitas untuk analisis mendalam  
        3. Jalankan Stress Test untuk risk assessment
        4. Tanya AI Assistant untuk bantuan
        
        **üí° Tips:**
        - Hover mouse pada üõà untuk info parameter
        - Klik "Refresh Data" untuk update terbaru
        - Gunakan sensitivity analysis untuk what-if scenarios
        """)
    
    # Changelog
    if st.sidebar.button("üìù What's New", use_container_width=True):
        changelog = AppConfig.get_changelog()
        st.sidebar.markdown("**üÜï Latest Updates:**")
        for version, changes in list(changelog.items())[:2]:  # Show last 2 versions
            st.sidebar.markdown(f"**{version}:**")
            for change in changes[:3]:  # Show first 3 changes
                st.sidebar.markdown(f"‚Ä¢ {change}")
            st.sidebar.markdown("---")
    
    # Footer sidebar
    st.sidebar.markdown("---")
    st.sidebar.markdown(
        f"<small style='color: #6b7280;'>¬© 2025 Badan Pengelola Keuangan Haji <br>"
        f"Build: {datetime.now().strftime('%H:%M')} WIB</small>", 
        unsafe_allow_html=True
    )
    
    # Main content based on selected page
    if page == "üè† Dashboard":
        render_dashboard(historical_data, exchange_rates, economic_indicators)
    elif page == "üßÆ Kalkulasi Liabilitas":
        render_liability_calculator(agents)
    elif page == "üìä Simulasi & Stress Test":
        render_simulation(agents)
    elif page == "ü§ñ AI Assistant":
        render_ai_assistant()
    elif page == "üìà Analytics":
        render_analytics(historical_data)
    elif page == "üìã Reports":
        render_reports(historical_data)
    
    # Footer Disclaimer
    render_footer_disclaimer()

# ====== PAGE RENDERING FUNCTIONS ======

# Updated render_dashboard function with Indonesia map visualization

# Updated render_dashboard function with Indonesia map visualization (Fixed Version)

def render_dashboard(historical_data, exchange_rates, economic_indicators, engines=None, ai_features_enabled=False):
    st.header("üìä Dashboard Monitoring Keberlanjutan")
    
    # KPI Metrics
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            label="üí∞ Total Aset Kelolaan", 
            value="Rp 180.5 T",
            delta="8.2% YTD",
            delta_color="normal"
        )
    
    with col2:
        st.metric(
            label="üìä Total Liabilitas",
            value="Rp 145.2 T",
            delta="3.1% dari proyeksi",
            delta_color="normal"
        )
    
    with col3:
        st.metric(
            label="üõ°Ô∏è Rasio Solvabilitas",
            value="1.24",
            delta="0.05 dari target",
            delta_color="normal"
        )
    
    with col4:
        st.metric(
            label="üìà Imbal Hasil (YTD)",
            value="8.2%",
            delta="1.7% di atas target",
            delta_color="normal"
        )
    
    # Charts section
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("üìà Tren Biaya Haji Historis")
        fig = px.line(
            historical_data, 
            x='Tahun', 
            y=['BPIH', 'NilaiManfaat'],
            title="Evolusi Biaya dan Nilai Manfaat",
            labels={'value': 'Rupiah', 'variable': 'Komponen'}
        )
        fig.update_layout(height=400)
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        st.subheader("üó∫Ô∏è Sebaran Jemaah per Provinsi")
        
        # Simplified province data with exactly matching array lengths
        provinces_data = {
            'Provinsi': [
                'Jawa Barat', 'Jawa Timur', 'Jawa Tengah', 'DKI Jakarta', 'Sumatera Utara',
                'Sumatera Barat', 'Sumatera Selatan', 'Lampung', 'Banten', 'DI Yogyakarta',
                'Kalimantan Selatan', 'Sulawesi Selatan', 'Nusa Tenggara Barat', 'Aceh',
                'Riau', 'Jambi', 'Bengkulu', 'Kepulauan Riau', 'Kalimantan Tengah',
                'Kalimantan Timur', 'Kalimantan Barat', 'Kalimantan Utara', 'Sulawesi Tengah',
                'Sulawesi Tenggara', 'Sulawesi Barat', 'Sulawesi Utara', 'Gorontalo',
                'Maluku', 'Maluku Utara', 'Papua', 'Papua Barat', 'Nusa Tenggara Timur', 'Bali'
            ],
            'Jemaah': [
                420000, 380000, 340000, 280000, 180000,  # Top 5 provinces
                160000, 145000, 130000, 125000, 110000,  # Next 5
                95000, 85000, 80000, 75000, 70000,       # Next 5
                65000, 60000, 55000, 50000, 45000,       # Next 5
                40000, 35000, 30000, 28000, 25000,       # Next 5
                22000, 20000, 18000, 15000, 12000,       # Next 5
                10000, 8000, 6000                        # Last 3
            ]
        }
        
        # Verify array lengths are equal
        assert len(provinces_data['Provinsi']) == len(provinces_data['Jemaah']), "Array lengths must match!"
        
        # Calculate percentages and create DataFrame
        total_jemaah = sum(provinces_data['Jemaah'])
        provinces_data['Persentase'] = [(j/total_jemaah)*100 for j in provinces_data['Jemaah']]
        
        df_provinces = pd.DataFrame(provinces_data)
        
        # Create pie chart for top 10 provinces + others
        top_10 = df_provinces.head(10).copy()
        others_sum = df_provinces.tail(len(df_provinces)-10)['Jemaah'].sum()
        others_pct = (others_sum/total_jemaah)*100
        
        top_10_with_others = pd.concat([
            top_10[['Provinsi', 'Jemaah', 'Persentase']],
            pd.DataFrame({
                'Provinsi': ['Provinsi Lainnya'],
                'Jemaah': [others_sum],
                'Persentase': [others_pct]
            })
        ])
        
        fig_pie = px.pie(
            top_10_with_others, 
            values='Jemaah', 
            names='Provinsi',
            title="Distribusi 2.5M Jemaah Tunggu (Top 10 + Lainnya)",
            color_discrete_sequence=px.colors.qualitative.Set3
        )
        fig_pie.update_traces(textposition='inside', textinfo='percent+label')
        fig_pie.update_layout(height=400)
        st.plotly_chart(fig_pie, use_container_width=True)
    
    # New Indonesia Scatter Map Section
    st.subheader("üó∫Ô∏è Peta Interaktif Distribusi Jemaah Indonesia")
    
    # Add approximate coordinates for provinces
    coordinates = {
        'Jawa Barat': [-6.9175, 107.6191], 'Jawa Timur': [-7.2504, 112.7688], 
        'Jawa Tengah': [-7.3069, 110.1765], 'DKI Jakarta': [-6.2088, 106.8456], 
        'Sumatera Utara': [3.5952, 98.6722], 'Sumatera Barat': [-0.7893, 100.6500],
        'Sumatera Selatan': [-3.3194, 103.9140], 'Lampung': [-4.5585, 105.4068],
        'Banten': [-6.4058, 106.0640], 'DI Yogyakarta': [-7.8753, 110.4262],
        'Kalimantan Selatan': [-3.0926, 115.2837], 'Sulawesi Selatan': [-3.6687, 119.9740],
        'Nusa Tenggara Barat': [-8.6529, 117.3616], 'Aceh': [4.6951, 96.7494],
        'Riau': [0.2933, 101.7068], 'Jambi': [-1.4852, 103.6118],
        'Bengkulu': [-3.8004, 102.2655], 'Kepulauan Riau': [3.9456, 108.1429],
        'Kalimantan Tengah': [-1.6814, 113.3823], 'Kalimantan Timur': [1.6406, 116.4194],
        'Kalimantan Barat': [-0.2787, 111.4752], 'Kalimantan Utara': [2.7200, 116.0553],
        'Sulawesi Tengah': [-1.4300, 121.4456], 'Sulawesi Tenggara': [-4.1468, 122.1750],
        'Sulawesi Barat': [-2.8441, 119.2320], 'Sulawesi Utara': [0.6246, 123.9750],
        'Gorontalo': [0.6999, 122.4467], 'Maluku': [-3.2385, 130.1453],
        'Maluku Utara': [1.5709, 127.8088], 'Papua': [-4.2699, 138.0804],
        'Papua Barat': [-1.3361, 133.1747], 'Nusa Tenggara Timur': [-8.6573, 121.0794],
        'Bali': [-8.4095, 115.1889]
    }
    
    # Add coordinates to dataframe
    df_provinces['Latitude'] = df_provinces['Provinsi'].map(lambda x: coordinates.get(x, [0, 0])[0])
    df_provinces['Longitude'] = df_provinces['Provinsi'].map(lambda x: coordinates.get(x, [0, 0])[1])
    
    # Create scatter map
    try:
        fig_map = px.scatter_geo(
            df_provinces,
            lat='Latitude',
            lon='Longitude',
            size='Jemaah',
            color='Jemaah',
            hover_name='Provinsi',
            hover_data={
                'Jemaah': ':,.0f',
                'Persentase': ':.1f%',
                'Latitude': False,
                'Longitude': False
            },
            color_continuous_scale='Reds',
            title="Distribusi Jemaah Tunggu per Provinsi di Indonesia",
            labels={'Jemaah': 'Jumlah Jemaah'},
            size_max=50
        )
        
        # Update map layout for Indonesia focus
        fig_map.update_layout(
            geo=dict(
                showframe=False,
                showcoastlines=True,
                projection_type='natural earth',
                center=dict(lat=-2.5, lon=118),  # Center on Indonesia
                scope='asia',
                resolution=50,
                showland=True,
                landcolor='rgb(243, 243, 243)',
                coastlinecolor='rgb(204, 204, 204)',
            ),
            height=500,
            title_x=0.5
        )
        
        st.plotly_chart(fig_map, use_container_width=True)
        
    except Exception as e:
        st.warning(f"‚ö†Ô∏è Could not display map: {e}")
        st.info("üí° Showing alternative visualization...")
        
        # Fallback: Simple bar chart
        fig_bar = px.bar(
            df_provinces.head(15),  # Top 15 provinces
            x='Jemaah',
            y='Provinsi',
            orientation='h',
            title="Top 15 Provinsi dengan Jemaah Tunggu Terbanyak",
            labels={'Jemaah': 'Jumlah Jemaah', 'Provinsi': 'Provinsi'},
            color='Jemaah',
            color_continuous_scale='Reds'
        )
        fig_bar.update_layout(height=500)
        st.plotly_chart(fig_bar, use_container_width=True)
    
    # Enhanced Data Table with Search and Sorting
    st.subheader("üìã Detail Distribusi Jemaah per Provinsi")
    
    # Add search functionality
    search_term = st.text_input("üîç Cari Provinsi:", placeholder="Ketik nama provinsi...")
    
    # Filter data based on search
    if search_term:
        filtered_df = df_provinces[df_provinces['Provinsi'].str.contains(search_term, case=False)]
    else:
        filtered_df = df_provinces
    
    # Sort options
    sort_by = st.selectbox(
        "üìä Urutkan berdasarkan:",
        ['Jemaah (Tertinggi)', 'Jemaah (Terendah)', 'Nama Provinsi (A-Z)', 'Nama Provinsi (Z-A)']
    )
    
    if sort_by == 'Jemaah (Tertinggi)':
        filtered_df = filtered_df.sort_values('Jemaah', ascending=False)
    elif sort_by == 'Jemaah (Terendah)':
        filtered_df = filtered_df.sort_values('Jemaah', ascending=True)
    elif sort_by == 'Nama Provinsi (A-Z)':
        filtered_df = filtered_df.sort_values('Provinsi', ascending=True)
    else:
        filtered_df = filtered_df.sort_values('Provinsi', ascending=False)
    
    # Format the dataframe for display (exclude coordinate columns)
    display_df = filtered_df[['Provinsi', 'Jemaah', 'Persentase']].copy()
    display_df['Jemaah'] = display_df['Jemaah'].apply(lambda x: f"{x:,}")
    display_df['Persentase'] = display_df['Persentase'].apply(lambda x: f"{x:.2f}%")
    
    # Rename columns for display
    display_df.columns = ['üèõÔ∏è Provinsi', 'üë• Jumlah Jemaah', 'üìä Persentase']
    
    st.dataframe(
        display_df,
        use_container_width=True,
        height=400
    )
    
    # Summary statistics
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üèõÔ∏è Total Provinsi", len(df_provinces))
    
    with col2:
        max_province = df_provinces.loc[df_provinces['Jemaah'].idxmax()]
        st.metric("üèÜ Provinsi Tertinggi", max_province['Provinsi'], f"{max_province['Jemaah']:,} jemaah")
    
    with col3:
        avg_jemaah = df_provinces['Jemaah'].mean()
        st.metric("üìä Rata-rata per Provinsi", f"{avg_jemaah:,.0f} jemaah")
    
    with col4:
        top_5_percentage = df_provinces.head(5)['Persentase'].sum()
        st.metric("üéØ Top 5 Provinsi", f"{top_5_percentage:.1f}% total jemaah")
    
    # Economic indicators section (rest remains the same)
    st.subheader("üìä Indikator Ekonomi Terkini")
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üíµ USD/IDR", f"Rp {exchange_rates['USD']:,}", "‚ÜóÔ∏è 0.5%")
    with col2:
        st.metric("üá∏üá¶ SAR/IDR", f"Rp {exchange_rates['SAR']:,}", "‚ÜóÔ∏è 0.3%")
    with col3:
        st.metric("üìà Inflasi Saudi", f"{economic_indicators['saudi_inflation']}%", "‚ÜòÔ∏è 0.2%")
    with col4:
        st.metric("üè¶ BI Rate", f"{economic_indicators['bi_rate']}%", "‚Üí 0%")
    
    # Alert system
    st.subheader("üö® Sistem Peringatan Dini")
    
    # Check for alerts based on current metrics
    alerts = []
    solvency_ratio = 1.24
    ytd_return = 8.2
    
    if solvency_ratio < 1.1:
        alerts.append({
            'level': 'danger',
            'title': 'Rasio Solvabilitas Rendah',
            'message': f'Rasio solvabilitas {solvency_ratio:.2f} mendekati batas minimum.'
        })
    
    if ytd_return < 5.0:
        alerts.append({
            'level': 'warning', 
            'title': 'Imbal Hasil di Bawah Target',
            'message': f'Imbal hasil YTD {ytd_return}% di bawah target 6.5%.'
        })
    
    if exchange_rates.get('USD', 15500) > 16000:
        alerts.append({
            'level': 'warning',
            'title': 'Kurs USD Tinggi',
            'message': 'Kurs USD/IDR melampaui level waspada Rp 16.000.'
        })
    
    if not alerts:
        st.success("‚úÖ Semua indikator dalam kondisi normal")
    else:
        for alert in alerts:
            if alert['level'] == 'danger':
                st.error(f"üö® **{alert['title']}**: {alert['message']}")
            else:
                st.warning(f"‚ö†Ô∏è **{alert['title']}**: {alert['message']}")
    
    # Data source info
    st.markdown(f"""
    <div class="info-box">
        <strong>üì° Data Sources:</strong><br>
        ‚Ä¢ Exchange Rates: {exchange_rates['source']}<br>
        ‚Ä¢ Economic Indicators: {economic_indicators['source']}<br>
        ‚Ä¢ Distribusi Jemaah: Data Simulasi BPKH 2025<br>
        ‚Ä¢ Last Update: {exchange_rates['timestamp'].strftime('%d %B %Y, %H:%M WIB')}
    </div>
    """, unsafe_allow_html=True)
    
    # Auto-refresh option
    if st.button("üîÑ Refresh Data (Simulasi Live Update)", type="primary"):
        st.cache_data.clear()
        st.success("‚úÖ Data berhasil di-refresh!")
        st.balloons()
        st.rerun()

# Additional helper function for alternative map visualization using Folium
def create_folium_indonesia_map(df_provinces):
    """Create an alternative Folium map for Indonesia pilgrim distribution"""
    import folium
    from folium import plugins
    
    # Create base map centered on Indonesia
    m = folium.Map(
        location=[-2.5, 118],  # Center of Indonesia
        zoom_start=5,
        tiles='OpenStreetMap'
    )
    
    # Add markers for each province (simplified coordinates)
    province_coords = {
        'Jawa Barat': [-6.9175, 107.6191],
        'Jawa Timur': [-7.2504, 112.7688],
        'Jawa Tengah': [-7.3069, 110.1765],
        'DKI Jakarta': [-6.2088, 106.8456],
        'Sumatera Utara': [3.5952, 98.6722],
        # Add more coordinates as needed
    }
    
    # Add choropleth layer (requires GeoJSON data for full implementation)
    # This is a simplified version using markers
    for idx, row in df_provinces.iterrows():
        if row['Provinsi'] in province_coords:
            lat, lon = province_coords[row['Provinsi']]
            
            # Create popup content
            popup_content = f"""
            <div style="width: 200px;">
                <h4>{row['Provinsi']}</h4>
                <p><strong>Jemaah:</strong> {row['Jemaah']:,}</p>
                <p><strong>Persentase:</strong> {row['Persentase']:.2f}%</p>
            </div>
            """
            
            # Add circle marker with size based on number of pilgrims
            folium.CircleMarker(
                location=[lat, lon],
                radius=min(row['Jemaah']/10000, 30),  # Scale radius
                popup=folium.Popup(popup_content, max_width=250),
                color='red',
                fillColor='red',
                fillOpacity=0.6,
                weight=2
            ).add_to(m)
    
    return m

def render_liability_calculator(agents):
    st.header("üßÆ Modul Kalkulasi Liabilitas Keuangan Haji")
    
    st.markdown("""
    ### üìã Formula Aktuaria yang Digunakan:
    **L_total = Œ£ (C_t √ó J_t) / (1+r)^t**
    
    Di mana:
    - **L_total**: Total Liabilitas Keuangan Haji (nilai kini)
    - **C_t**: Biaya per jemaah pada tahun t
    - **J_t**: Jumlah jemaah pada tahun t  
    - **r**: Tingkat diskonto
    """)
    
    # Input parameters
    st.subheader("‚öôÔ∏è Parameter Input")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        total_jemaah = st.number_input(
            "üë• Total Jemaah Tunggu",
            min_value=1000000,
            max_value=5000000,
            value=AppConfig.DEFAULT_TOTAL_JEMAAH,
            step=50000,
            help="Jumlah total jemaah dalam daftar tunggu"
        )
        
        inflasi_saudi = st.number_input(
            "üìä Inflasi Saudi (%/tahun)",
            min_value=0.0,
            max_value=15.0,
            value=AppConfig.DEFAULT_INFLASI_SAUDI,
            step=0.1,
            help="Asumsi inflasi tahunan di Arab Saudi"
        )
    
    with col2:
        kurs_usd = st.number_input(
            "üíµ Kurs USD (Rupiah)",
            min_value=10000,
            max_value=25000,
            value=AppConfig.DEFAULT_KURS_USD,
            step=100,
            help="Kurs USD terhadap Rupiah"
        )
        
        tingkat_diskonto = st.number_input(
            "üè¶ Tingkat Diskonto (%)",
            min_value=3.0,
            max_value=15.0,
            value=AppConfig.DEFAULT_TINGKAT_DISKONTO,
            step=0.1,
            help="Tingkat diskonto untuk menghitung present value"
        )
    
    with col3:
        biaya_awal = st.number_input(
            "üí∞ Biaya Awal per Jemaah (Rp)",
            min_value=50000000,
            max_value=150000000,
            value=94482028,
            step=1000000,
            help="Biaya penyelenggaraan haji per jemaah saat ini"
        )
        
        tahun_proyeksi = st.number_input(
            "üìÖ Tahun Proyeksi",
            min_value=10,
            max_value=30,
            value=AppConfig.DEFAULT_TAHUN_PROYEKSI,
            step=5,
            help="Periode proyeksi untuk kalkulasi liabilitas"
        )
    
    # Calculate liability
    if st.button("üî¨ Hitung Liabilitas", type="primary"):
        with st.spinner("ü§ñ AI Agent sedang menghitung..."):
            total_liability, projections = agents.calculate_liability(
                total_jemaah, inflasi_saudi, kurs_usd, biaya_awal, tingkat_diskonto, tahun_proyeksi
            )
            
            # Display results
            st.markdown(f"""
            <div class="liability-result">
                <h2>üí∞ Total Present Value of Hajj Liability</h2>
                <h1>{format_rupiah(total_liability)}</h1>
                <p>Berdasarkan kalkulasi aktuaria dengan proyeksi {tahun_proyeksi} tahun</p>
                <p>Equivalent to: {total_liability/1e12:.2f} Trillion Rupiah</p>
            </div>
            """, unsafe_allow_html=True)
            
            # Projection chart
            st.subheader("üìä Proyeksi Kebutuhan Dana per Tahun")
            df_proj = pd.DataFrame(projections)
            
            fig = make_subplots(
                rows=2, cols=1,
                subplot_titles=('Total Biaya per Tahun (Triliun Rupiah)', 'Biaya per Jemaah (Juta Rupiah)'),
                vertical_spacing=0.1
            )
            
            fig.add_trace(
                go.Bar(
                    x=df_proj['tahun'],
                    y=df_proj['total_biaya'] / 1e12,
                    name='Total Biaya (Triliun)',
                    marker_color='#10b981'
                ),
                row=1, col=1
            )
            
            fig.add_trace(
                go.Scatter(
                    x=df_proj['tahun'],
                    y=df_proj['biaya_per_jemaah'] / 1e6,
                    mode='lines+markers',
                    name='Biaya per Jemaah (Juta)',
                    line=dict(color='#3b82f6', width=3)
                ),
                row=2, col=1
            )
            
            fig.update_layout(height=600, showlegend=True)
            st.plotly_chart(fig, use_container_width=True)
            
            # Sensitivity analysis
            st.subheader("üìà Analisis Sensitivitas")
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**üîÑ Sensitivitas terhadap Inflasi Saudi**")
                inflasi_scenarios = [2.0, 3.5, 5.0, 6.5, 8.0]
                sensitivity_inflasi = []
                
                for inflasi in inflasi_scenarios:
                    liability, _ = agents.calculate_liability(
                        total_jemaah, inflasi, kurs_usd, biaya_awal, tingkat_diskonto, tahun_proyeksi
                    )
                    sensitivity_inflasi.append({
                        'Inflasi (%)': inflasi,
                        'Total Liabilitas': format_rupiah(liability),
                        'Perubahan (%)': f"{((liability - total_liability) / total_liability) * 100:.1f}%"
                    })
                
                df_sens = pd.DataFrame(sensitivity_inflasi)
                st.dataframe(df_sens, use_container_width=True)
            
            with col2:
                st.markdown("**üí± Sensitivitas terhadap Kurs USD**")
                kurs_scenarios = [14000, 15500, 17000, 18500, 20000]
                sensitivity_kurs = []
                
                for kurs in kurs_scenarios:
                    liability, _ = agents.calculate_liability(
                        total_jemaah, inflasi_saudi, kurs, biaya_awal, tingkat_diskonto, tahun_proyeksi
                    )
                    sensitivity_kurs.append({
                        'Kurs USD': f"Rp {kurs:,}",
                        'Total Liabilitas': format_rupiah(liability),
                        'Perubahan (%)': f"{((liability - total_liability) / total_liability) * 100:.1f}%"
                    })
                
                df_kurs = pd.DataFrame(sensitivity_kurs)
                st.dataframe(df_kurs, use_container_width=True)
            
            # Summary statistics
            st.subheader("üìã Ringkasan Hasil Kalkulasi")
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("üìä Total Liability", format_rupiah(total_liability))
            with col2:
                avg_annual = total_liability / tahun_proyeksi
                st.metric("üìÖ Rata-rata per Tahun", format_rupiah(avg_annual))
            with col3:
                cost_per_pilgrim = total_liability / total_jemaah
                st.metric("üë§ Present Value per Jemaah", format_rupiah(cost_per_pilgrim))
            with col4:
                st.metric("‚è±Ô∏è Periode Proyeksi", f"{tahun_proyeksi} tahun")

def render_simulation(agents):
    st.header("üìä Simulasi & Stress Testing")
    
    # Scenario selection
    st.subheader("üéØ Pilih Skenario Stress Test")
    scenario = st.selectbox(
        "Skenario",
        ["üìä Skenario Dasar", "üìâ Resesi Global", "üí± Depresiasi Rupiah Ekstrem", "üìà Inflasi Saudi Tinggi", "‚ö° Shock Ganda"]
    )
    
    # Base parameters
    base_liability = 145.2  # trillion
    base_assets = 180.5     # trillion
    base_solvency = base_assets / base_liability
    
    # Scenario parameters
    scenarios = {
        "üìä Skenario Dasar": {"liability_mult": 1.0, "asset_mult": 1.0, "description": "Kondisi normal tanpa shock eksternal"},
        "üìâ Resesi Global": {"liability_mult": 1.15, "asset_mult": 0.85, "description": "Imbal hasil investasi turun, biaya naik"},
        "üí± Depresiasi Rupiah Ekstrem": {"liability_mult": 1.45, "asset_mult": 0.95, "description": "Rupiah melemah 30% dalam 2 tahun"},
        "üìà Inflasi Saudi Tinggi": {"liability_mult": 1.25, "asset_mult": 1.02, "description": "Inflasi Saudi mencapai 8% per tahun"},
        "‚ö° Shock Ganda": {"liability_mult": 1.60, "asset_mult": 0.80, "description": "Kombinasi resesi + depresiasi + inflasi"}
    }
    
    selected_scenario = scenarios[scenario]
    
    # Calculate scenario results
    scenario_liability = base_liability * selected_scenario["liability_mult"]
    scenario_assets = base_assets * selected_scenario["asset_mult"]
    scenario_solvency = scenario_assets / scenario_liability
    
    # Display scenario info
    st.info(f"**{scenario}**: {selected_scenario['description']}")
    
    # Results display
    col1, col2, col3 = st.columns(3)
    
    with col1:
        liability_delta = ((scenario_liability - base_liability) / base_liability) * 100
        st.metric(
            "üí∞ Total Liabilitas",
            f"Rp {scenario_liability:.1f}T",
            f"{liability_delta:+.1f}%",
            delta_color="inverse"
        )
    
    with col2:
        assets_delta = ((scenario_assets - base_assets) / base_assets) * 100
        st.metric(
            "üìä Total Aset",
            f"Rp {scenario_assets:.1f}T",
            f"{assets_delta:+.1f}%"
        )
    
    with col3:
        solvency_delta = scenario_solvency - base_solvency
        status = "normal" if scenario_solvency > 1.0 else "inverse"
        st.metric(
            "üõ°Ô∏è Rasio Solvabilitas",
            f"{scenario_solvency:.2f}",
            f"{solvency_delta:+.2f}",
            delta_color=status
        )
    
    # Status assessment
    if scenario_solvency >= 1.2:
        st.markdown("""
        <div class="stress-test-safe">
            <strong>‚úÖ STATUS: AMAN</strong><br>
            Rasio solvabilitas masih berada dalam zona aman. BPKH mampu memenuhi kewajiban.
        </div>
        """, unsafe_allow_html=True)
    elif scenario_solvency >= 1.0:
        st.markdown("""
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin: 0.5rem 0;">
            <strong>‚ö†Ô∏è STATUS: WASPADA</strong><br>
            Rasio solvabilitas menurun tapi masih di atas 1.0. Perlu monitoring ketat.
        </div>
        """, unsafe_allow_html=True)
    else:
        st.markdown("""
        <div class="stress-test-risk">
            <strong>üö® STATUS: RISIKO TINGGI</strong><br>
            Rasio solvabilitas di bawah 1.0. Diperlukan tindakan mitigasi segera.
        </div>
        """, unsafe_allow_html=True)
    
    # Comparative chart
    st.subheader("üìà Perbandingan Skenario")
    
    comparison_data = {
        'Skenario': list(scenarios.keys()),
        'Liabilitas': [base_liability * scenarios[s]["liability_mult"] for s in scenarios.keys()],
        'Aset': [base_assets * scenarios[s]["asset_mult"] for s in scenarios.keys()],
        'Rasio Solvabilitas': [
            (base_assets * scenarios[s]["asset_mult"]) / (base_liability * scenarios[s]["liability_mult"])
            for s in scenarios.keys()
        ]
    }
    
    df_comparison = pd.DataFrame(comparison_data)
    
    fig = make_subplots(
        rows=1, cols=2,
        subplot_titles=('Aset vs Liabilitas (Triliun Rp)', 'Rasio Solvabilitas'),
        specs=[[{"secondary_y": False}, {"secondary_y": False}]]
    )
    
    fig.add_trace(
        go.Bar(x=df_comparison['Skenario'], y=df_comparison['Aset'], name='Aset', marker_color='#10b981'),
        row=1, col=1
    )
    fig.add_trace(
        go.Bar(x=df_comparison['Skenario'], y=df_comparison['Liabilitas'], name='Liabilitas', marker_color='#ef4444'),
        row=1, col=1
    )
    
    fig.add_trace(
        go.Scatter(
            x=df_comparison['Skenario'], 
            y=df_comparison['Rasio Solvabilitas'], 
            mode='lines+markers',
            name='Rasio Solvabilitas',
            line=dict(color='#3b82f6', width=3),
            marker=dict(size=8)
        ),
        row=1, col=2
    )
    
    # Add threshold line
    fig.add_hline(y=1.0, line_dash="dash", line_color="red", row=1, col=2, annotation_text="Batas Minimum")
    
    fig.update_layout(height=500, showlegend=True)
    st.plotly_chart(fig, use_container_width=True)
    
    # Monte Carlo simulation
    st.subheader("üé≤ Simulasi Monte Carlo")
    if st.button("üöÄ Jalankan Simulasi Monte Carlo (1000 iterasi)"):
        with st.spinner("üî¨ Menjalankan 1000 simulasi..."):
            results = StressTestEngine.monte_carlo_simulation(base_assets * 1e12, base_liability * 1e12, 1000)
            
            # Create histogram
            fig = px.histogram(
                x=results['solvency_ratios'],
                nbins=50,
                title="Distribusi Rasio Solvabilitas (1000 Simulasi Monte Carlo)",
                labels={'x': 'Rasio Solvabilitas', 'y': 'Frekuensi'},
                color_discrete_sequence=['#10b981']
            )
            fig.add_vline(x=1.0, line_dash="dash", line_color="red", annotation_text="Batas Minimum")
            fig.add_vline(x=results['mean_solvency'], line_dash="dot", line_color="blue", annotation_text="Rata-rata")
            
            st.plotly_chart(fig, use_container_width=True)
            
            # Statistics
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("üìä Rata-rata Rasio", f"{results['mean_solvency']:.2f}")
            with col2:
                st.metric("üõ°Ô∏è Probabilitas Aman", f"{results['safe_probability']:.1f}%")
            with col3:
                st.metric("üìâ Skenario Terburuk", f"{results['worst_case']:.2f}")

def render_ai_assistant():
    st.header("ü§ñ Asisten Cerdas BPKH")
    
    st.markdown("""
    ### üí° Tanyakan tentang:
    - üìä Data keuangan dan liabilitas
    - üìà Proyeksi dan simulasi
    - üìã Regulasi dan kebijakan haji
    - üí∞ Strategi investasi dan manajemen risiko
    """)
    
    # Chat interface
    if "messages" not in st.session_state:
        st.session_state.messages = [
            {"role": "assistant", "content": "üëã Selamat datang! Saya adalah Asisten Cerdas BPKH. Bagaimana saya bisa membantu Anda hari ini?"}
        ]
    
    # Display chat messages
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
    
    # Chat input
    if prompt := st.chat_input("Tanyakan sesuatu..."):
        # Add user message
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)
        
        # Generate assistant response
        with st.chat_message("assistant"):
            with st.spinner("ü§î Sedang berpikir..."):
                response = generate_ai_response(prompt)
                st.markdown(response)
        
        st.session_state.messages.append({"role": "assistant", "content": response})
    
    # Quick questions
    st.markdown("### ‚ö° Pertanyaan Cepat")
    quick_questions = [
        "Berapa total liabilitas saat ini?",
        "Bagaimana cara menghitung rasio solvabilitas?",
        "Apa dampak inflasi Saudi terhadap biaya haji?",
        "Regulasi apa yang mengatur investasi dana haji?",
        "Bagaimana cara melakukan stress test?",
        "Proyeksi biaya haji 5 tahun ke depan?"
    ]
    
    cols = st.columns(2)
    for i, question in enumerate(quick_questions):
        with cols[i % 2]:
            if st.button(question, key=f"quick_{i}"):
                st.session_state.messages.append({"role": "user", "content": question})
                response = generate_ai_response(question)
                st.session_state.messages.append({"role": "assistant", "content": response})
                st.rerun()

def render_analytics(historical_data):
    st.header("üìà Advanced Analytics")
    
    # Trend analysis
    st.subheader("üìä Analisis Tren & Pola")
    
    # Calculate growth rates
    historical_data_copy = historical_data.copy()
    historical_data_copy['BPIH_Growth'] = historical_data_copy['BPIH'].pct_change() * 100
    historical_data_copy['NilaiManfaat_Growth'] = historical_data_copy['NilaiManfaat'].pct_change() * 100
    
    col1, col2 = st.columns(2)
    
    with col1:
        fig = px.bar(
            historical_data_copy.dropna(), 
            x='Tahun', 
            y='BPIH_Growth',
            title="Pertumbuhan BPIH (% Year-on-Year)",
            labels={'BPIH_Growth': 'Pertumbuhan (%)'},
            color='BPIH_Growth',
            color_continuous_scale='RdYlGn'
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        fig = px.bar(
            historical_data_copy.dropna(), 
            x='Tahun', 
            y='NilaiManfaat_Growth',
            title="Pertumbuhan Nilai Manfaat (% YoY)",
            labels={'NilaiManfaat_Growth': 'Pertumbuhan (%)'},
            color='NilaiManfaat_Growth',
            color_continuous_scale='RdYlGn_r'
        )
        st.plotly_chart(fig, use_container_width=True)
    
    # Key insights
    st.subheader("üí° Key Insights")
    
    avg_growth = historical_data_copy['BPIH_Growth'].mean()
    volatility = historical_data_copy['BPIH_Growth'].std()
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("üìà Rata-rata Pertumbuhan BPIH", f"{avg_growth:.1f}%/tahun")
    
    with col2:
        st.metric("üìä Volatilitas Pertumbuhan", f"{volatility:.1f}%")
    
    with col3:
        latest_efficiency = (historical_data.iloc[-1]['NilaiManfaat'] / historical_data.iloc[-1]['BPIH']) * 100
        st.metric("‚ö° Efisiensi Nilai Manfaat", f"{latest_efficiency:.1f}%")
    
    # More analytics coming soon
    st.info("üöß Fitur analytics lanjutan sedang dalam pengembangan. Coming soon!")

def render_reports(historical_data):
    st.header("üìã Report Generation")
    
    # Report options
    st.subheader("üìä Pilih Jenis Laporan")
    
    report_type = st.selectbox(
        "Jenis Laporan",
        ["üìà Laporan Dashboard Eksekutif", "üßÆ Laporan Kalkulasi Liabilitas", "üß™ Laporan Stress Testing", "üìä Laporan Analisis Komprehensif"]
    )
    
    report_period = st.selectbox(
        "Periode Laporan",
        ["Bulanan", "Kuartalan", "Tahunan"]
    )
    
    # Generate report preview
    if st.button("üìÑ Generate Preview Laporan", type="primary"):
        with st.spinner("üìù Menyiapkan laporan..."):
            current_date = datetime.now().strftime("%d %B %Y")
            
            if "Dashboard" in report_type:
                report_content = f"""
                # üìä LAPORAN DASHBOARD EKSEKUTIF BPKH
                **Tanggal**: {current_date}
                
                ## üéØ RINGKASAN EKSEKUTIF
                
                ### Key Performance Indicators:
                - **Total Aset Kelolaan**: Rp 180.5 Triliun (‚ÜóÔ∏è 8.2% YTD)
                - **Total Liabilitas**: Rp 145.2 Triliun 
                - **Rasio Solvabilitas**: 1.24 (Status: ‚úÖ Aman)
                - **Imbal Hasil Investasi**: 8.2% YTD (Target: 6.5%)
                
                ### üìà Tren Utama:
                - Biaya haji menunjukkan tren naik rata-rata 4.9% per tahun
                - Nilai manfaat mengalami penurunan efisiensi
                - Rasio solvabilitas tetap dalam zona aman
                
                ### üéØ Rekomendasi:
                1. **Optimalisasi Portofolio**: Tingkatkan alokasi di instrumen dengan imbal hasil tinggi
                2. **Mitigasi Risiko**: Implementasi hedging untuk risiko mata uang
                3. **Efisiensi Operasional**: Review ulang struktur biaya untuk meningkatkan nilai manfaat
                """
            else:
                report_content = f"""
                # üìã LAPORAN {report_type.upper()}
                **Tanggal**: {current_date}
                **Periode**: {report_period}
                
                ## üìä STATUS LAPORAN
                üöß Template laporan untuk {report_type} sedang dalam pengembangan.
                
                Laporan akan mencakup:
                - Analisis komprehensif sesuai jenis laporan
                - Visualisasi data interaktif
                - Rekomendasi strategis
                - Proyeksi dan simulasi
                
                **Coming Soon!**
                """
            
            st.success("‚úÖ Preview laporan berhasil dibuat!")
            st.markdown(report_content)
            
            # Download simulation
            st.markdown("### ‚¨áÔ∏è Download Laporan")
            col1, col2, col3 = st.columns(3)
            
            with col1:
                if st.button("üìÑ Download PDF"):
                    st.info("üìÅ Fitur download PDF akan segera tersedia!")
            
            with col2:
                if st.button("üìä Download Excel"):
                    st.info("üìÅ Fitur download Excel akan segera tersedia!")
            
            with col3:
                if st.button("üìù Download Word"):
                    st.info("üìÅ Fitur download Word akan segera tersedia!")

# ====== MAIN EXECUTION ======
if __name__ == "__main__":
    main()